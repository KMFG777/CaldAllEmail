{% extends 'base.html' %}

{% block content %}
<h1>الدعم الفني</h1>
<p>أرسل رسالة مباشرة إلى كالد وسيتم الرد عليك في أقرب وقت.</p>

<div class="chat-box" id="chat-box">
    <div class="message bot">
        أهلاً بك! يمكنك إرسال أي استفسار أو رسالة هنا.
    </div>
</div>
<div id="reply-notify" class="card" style="display:none;">
    <h3 style="color: var(--accent-green);">ردود جديدة على رسائلك</h3>
    <div id="reply-list"></div>
</div>

<form id="chat-form" style="display: flex; gap: 10px;">
    <input type="text" id="user-input" placeholder="اكتب رسالتك هنا..." required style="margin-bottom: 0;">
    <button type="submit" class="btn btn-green">إرسال</button>
</form>

<script>
    const chatBox = document.getElementById('chat-box');
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');

    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const content = userInput.value;
        if (!content) return;

        // Add user message
        addMessage(content, 'user');
        userInput.value = '';
        
        // Send to backend
        const formData = new FormData();
        formData.append('content', content);

        fetch('/chat', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            addMessage(data.response, 'bot');
        })
        .catch(err => {
            console.error(err);
            addMessage("حدث خطأ في الاتصال.", 'bot');
        });
    });

    function addMessage(text, sender) {
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        div.textContent = text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
    // Poll for replies if logged in
    setInterval(() => {
        fetch('/my_replies')
            .then(r => r.json())
            .then(list => {
                if (Array.isArray(list) && list.length) {
                    const box = document.getElementById('reply-notify');
                    const listDiv = document.getElementById('reply-list');
                    box.style.display = 'block';
                    listDiv.innerHTML = '';
                    list.forEach(item => {
                        const p = document.createElement('p');
                        p.innerHTML = `<strong>رسالتك:</strong> ${item.content}<br/><strong>رد كالد:</strong> ${item.reply} <small>${item.at}</small>`;
                        listDiv.appendChild(p);
                    });
                }
            }).catch(()=>{});
    }, 5000);
</script>
{% endblock %}
